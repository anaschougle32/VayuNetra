{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
.pollution-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
}

.alert-card {
    border-left: 4px solid #f59e0b;
    background: #fef3c7;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.alert-high {
    border-left-color: #ef4444;
    background: #fee2e2;
}

.alert-critical {
    border-left-color: #991b1b;
    background: #fecaca;
}

.impact-card {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    text-align: center;
}

.zone-marker {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}

.zone-heavy { background-color: #dc2626; }
.zone-manufacturing { background-color: #f59e0b; }
.zone-light { background-color: #10b981; }
.zone-mixed { background-color: #6b7280; }

.map-container {
    height: 400px;
    border-radius: 15px;
    overflow: hidden;
    border: 2px solid #e5e7eb;
}

.legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin-right: 10px;
    border: 2px solid #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .map-container {
        height: 300px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Pollution Awareness Dashboard</h1>
        <p class="text-gray-600">Monitor air quality and industrial zones in your area</p>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
        <!-- Recent Locations -->
        <div class="pollution-card">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Recent Locations</h3>
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </div>
            <div class="text-3xl font-bold mb-2">{{ recent_locations|length }}</div>
            <p class="text-sm opacity-90">Locations tracked</p>
        </div>

        <!-- Unread Alerts -->
        <div class="pollution-card">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Pollution Alerts</h3>
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
            </div>
            <div class="text-3xl font-bold mb-2">{{ unread_alerts|length }}</div>
            <p class="text-sm opacity-90">Active alerts</p>
        </div>

        <!-- Industrial Zones -->
        <div class="pollution-card">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Industrial Zones</h3>
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
            </div>
            <div class="text-3xl font-bold mb-2">{{ nearby_zones|length }}</div>
            <p class="text-sm opacity-90">Nearby zones</p>
        </div>

        <!-- Environmental Impact -->
        <div class="impact-card">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Your Impact</h3>
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <div class="text-3xl font-bold mb-2">{{ recent_impacts|length }}</div>
            <p class="text-sm opacity-90">Impact records</p>
        </div>
    </div>

    <!-- AQI by Location -->
    <div class="bg-white rounded-lg shadow-md p-6 mt-8">
        <h2 class="text-xl font-semibold mb-4">AQI by Location</h2>
        {% if recent_aqi_records %}
        <div class="grid md:grid-cols-2 gap-4">
            {% for record in recent_aqi_records %}
            <div class="p-4 border border-gray-200 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="font-semibold text-gray-800">{{ record.location.name|default:record.location.address }}</h4>
                        <p class="text-sm text-gray-500">{{ record.timestamp|date:"M d, Y H:i" }}</p>
                    </div>
                    <span class="text-2xl font-bold text-gray-800">{{ record.value|floatformat:0 }}</span>
                </div>
                <p class="text-sm text-gray-600 mt-2">AQI Level: {{ record.get_aqi_level_display }}</p>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-gray-600">No AQI records yet. Add a location to see AQI data.</p>
        {% endif %}
    </div>

    <!-- Recent Pollution Records -->
    <div class="bg-white rounded-lg shadow-md p-6 mt-8">
        <h2 class="text-xl font-semibold mb-4">Recent Pollution Records</h2>
        {% if recent_pollution_records %}
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead>
                    <tr class="text-left text-gray-500 border-b">
                        <th class="py-2 pr-4">Location</th>
                        <th class="py-2 pr-4">Pollutant</th>
                        <th class="py-2 pr-4">Value</th>
                        <th class="py-2 pr-4">AQI Level</th>
                        <th class="py-2">Time</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in recent_pollution_records %}
                    <tr class="border-b last:border-b-0">
                        <td class="py-2 pr-4 text-gray-800">{{ record.location.name|default:record.location.address }}</td>
                        <td class="py-2 pr-4 text-gray-600">{{ record.get_pollutant_type_display }}</td>
                        <td class="py-2 pr-4 text-gray-800">{{ record.value }} {{ record.unit }}</td>
                        <td class="py-2 pr-4 text-gray-600">{{ record.get_aqi_level_display }}</td>
                        <td class="py-2 text-gray-500">{{ record.timestamp|date:"M d, Y H:i" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-600">No recent pollution records found.</p>
        {% endif %}
    </div>

    <!-- Industrial Zones List -->
    <div class="bg-white rounded-lg shadow-md p-6 mt-8">
        <h2 class="text-xl font-semibold mb-4">Industrial Zones</h2>
        {% if nearby_zones %}
        <div class="grid md:grid-cols-2 gap-4">
            {% for zone in nearby_zones %}
            <div class="p-4 border border-gray-200 rounded-lg">
                <h4 class="font-semibold text-gray-800">{{ zone.name }}</h4>
                <p class="text-sm text-gray-600">Type: {{ zone.zone_type|title }}</p>
                <p class="text-sm text-gray-600">Emission Intensity: {{ zone.emission_intensity }} t/yr</p>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-gray-600">No industrial zones available.</p>
        {% endif %}
    </div>

    <!-- Impact Records -->
    <div class="bg-white rounded-lg shadow-md p-6 mt-8">
        <h2 class="text-xl font-semibold mb-4">Impact Records</h2>
        {% if recent_impacts %}
        <div class="grid md:grid-cols-2 gap-4">
            {% for impact in recent_impacts %}
            <div class="p-4 border border-gray-200 rounded-lg">
                <p class="text-sm text-gray-500">{{ impact.calculation_date|date:"M d, Y" }}</p>
                <p class="text-gray-800">Carbon Saved: <span class="font-semibold">{{ impact.carbon_savings_kg }}</span> kg</p>
                <p class="text-gray-800">Factory Hours Offset: <span class="font-semibold">{{ impact.equivalent_factory_hours }}</span></p>
                <p class="text-gray-800">Trees Equivalent: <span class="font-semibold">{{ impact.trees_planted_equivalent }}</span></p>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-gray-600">No impact records yet. Log trips to see your impact.</p>
        {% endif %}
    </div>

    <!-- Industrial Zones & AQI Map -->
    <div class="bg-white rounded-lg shadow-md p-6 mt-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Industrial Zones & Air Quality</h2>
            <div class="flex gap-2">
                <button onclick="toggleIndustrialZones()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                    üè≠ Industrial Zones
                </button>
                <button onclick="toggleAQILayer()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
                    üå¨Ô∏è Air Quality
                </button>
                <button onclick="refreshMapData()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                    üîÑ Refresh
                </button>
            </div>
        </div>
        <div id="pollution-map" class="map-container"></div>
        
        <!-- Map Legend -->
        <div class="flex flex-wrap gap-4 text-sm mt-4">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #10b981;"></div>
                <span>Good AQI (0-50)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #f59e0b;"></div>
                <span>Moderate AQI (51-100)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #ef4444;"></div>
                <span>Unhealthy AQI (101-150)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #991b1b;"></div>
                <span>Very Unhealthy AQI (151+)</span>
            </div>
        </div>
    </div>

    <!-- Recent Alerts -->
    {% if unread_alerts %}
    <div class="bg-white rounded-lg shadow-md p-6 mt-8">
        <h2 class="text-xl font-semibold mb-4">Recent Pollution Alerts</h2>
        <div class="space-y-4">
            {% for alert in unread_alerts %}
            <div class="alert-card {% if alert.severity == 'high' %}alert-high{% elif alert.severity == 'critical' %}alert-critical{% endif %}">
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-semibold text-gray-800">{{ alert.title }}</h4>
                        <p class="text-gray-600 text-sm mt-1">{{ alert.message }}</p>
                    </div>
                    <span class="text-xs text-gray-500">{{ alert.created_at|date:"M d, Y H:i" }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Hidden data for JavaScript -->
    {{ nearby_zones|json_script:"industrial-zones-data" }}
    {{ recent_locations|json_script:"recent-locations-data" }}
</div>
{% endblock %}

{% block extra_js %}
<!-- Load our JavaScript file -->
<script src="{% static 'js/pollution-dashboard.js?v=13.0.0&nocache=true' %}"></script>

<!-- Load Google Maps API with provided API key and callback -->
{% if google_maps_api_key and google_maps_api_key != 'AIzaSyA-test-key-for-development-only' and google_maps_api_key|length > 20 %}
<script>
    // Define error handler for Google Maps
    window.gm_authFailure = function() {
        console.error('Google Maps authentication failed - RefererNotAllowedMapError');
        document.getElementById('pollution-map').innerHTML = '<div class="p-4 bg-red-100 text-red-800 rounded">' +
            '<strong>Google Maps API Key Restriction Error</strong><br>' +
            '<p class="mt-2 text-sm">Your API key has HTTP referrer restrictions that are blocking this domain.</p>' +
            '<p class="mt-2 text-sm font-semibold">To fix this:</p>' +
            '<ol class="list-decimal list-inside mt-2 text-sm space-y-1">' +
            '<li>Go to Google Cloud Console ‚Üí APIs & Services ‚Üí Credentials</li>' +
            '<li>Find your API key and click "Edit API key"</li>' +
            '<li>Under "Application restrictions", add this domain to HTTP referrers</li>' +
            '<li>Save and wait a few minutes for changes to take effect</li>' +
            '</ol>' +
            '</div>';
    };
    
    // Load Google Maps API with proper error handling
    (function() {
        var script = document.createElement('script');
        script.type = 'text/javascript';
        var apiKey = '{{ google_maps_api_key }}';
        script.src = 'https://maps.googleapis.com/maps/api/js?key=' + apiKey + '&libraries=places,geometry,visualization&callback=initPollutionMap';
        script.async = true;
        script.defer = true;
        
        script.onerror = function() {
            console.error('Failed to load Google Maps API script');
            document.getElementById('pollution-map').innerHTML = `
                <div class="p-4 bg-red-100 text-red-800 rounded">
                    <strong>Failed to Load Google Maps</strong><br>
                    <p class="mt-2 text-sm">The Google Maps script failed to load. Possible causes:</p>
                    <ul class="list-disc list-inside mt-2 text-sm">
                        <li>Invalid API key</li>
                        <li>Network connectivity issues</li>
                        <li>Browser blocking the script</li>
                    </ul>
                </div>
            `;
        };
        
        // Add timeout check
        var timeout = setTimeout(function() {
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                console.error('Google Maps API did not load within timeout period');
                document.getElementById('pollution-map').innerHTML = `
                    <div class="p-4 bg-yellow-100 text-yellow-800 rounded">
                        <strong>Google Maps Taking Too Long</strong><br>
                        <p class="mt-2 text-sm">The map is taking longer than expected to load. Please:</p>
                        <ul class="list-disc list-inside mt-2 text-sm">
                            <li>Check your internet connection</li>
                            <li>Refresh the page</li>
                            <li>Try a different browser</li>
                        </ul>
                    </div>
                `;
            }
        }, 10000); // 10 second timeout
        
        script.onload = function() {
            clearTimeout(timeout);
            console.log('Google Maps API script loaded successfully');
            // Initialize map after script loads
            if (typeof google !== 'undefined' && google.maps) {
                initPollutionMap();
            }
        };
        
        document.head.appendChild(script);
    })();
</script>
{% else %}
<script>
    console.error('Google Maps API key not configured or invalid');
    console.log('API Key value:', '{{ google_maps_api_key }}');
    console.log('API Key length:', '{{ google_maps_api_key|length }}');
    
    function initPollutionMap() {
        console.error('Google Maps API key not available');
        var errorMsg = '';
        if (!'{{ google_maps_api_key }}' || '{{ google_maps_api_key }}' === 'AIzaSyA-test-key-for-development-only') {
            errorMsg = `
                <div class="p-4 bg-red-100 text-red-800 rounded">
                    <strong>Google Maps API Key Not Configured</strong><br>
                    <p class="mt-2 text-sm">Please set GOOGLE_MAPS_API_KEY in your environment variables or Django settings.</p>
                    <p class="mt-2 text-xs">Current value: {{ google_maps_api_key|default:"Not set" }}</p>
                </div>
            `;
        } else {
            errorMsg = `
                <div class="p-4 bg-red-100 text-red-800 rounded">
                    <strong>Invalid Google Maps API Key</strong><br>
                    <p class="mt-2 text-sm">The API key appears to be invalid or too short.</p>
                </div>
            `;
        }
        document.getElementById('pollution-map').innerHTML = errorMsg;
    }
</script>
{% endif %}
{% endblock %}
