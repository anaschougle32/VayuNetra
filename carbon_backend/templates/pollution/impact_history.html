{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
.impact-container {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
}

.impact-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
}

.impact-card {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    transition: transform 0.3s ease;
}

.impact-card:hover {
    transform: translateY(-4px);
}

.impact-card.negative {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

.impact-card.neutral {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
}

.impact-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.impact-value {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.impact-label {
    font-size: 1.125rem;
    opacity: 0.9;
}

.history-timeline {
    position: relative;
    padding-left: 2rem;
}

.history-timeline::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e5e7eb;
}

.timeline-item {
    position: relative;
    margin-bottom: 2rem;
    padding: 1.5rem;
    border-radius: 12px;
    background: #f9fafb;
    border-left: 4px solid #10b981;
    transition: all 0.3s ease;
}

.timeline-item:hover {
    background: #f3f4f6;
    transform: translateX(4px);
}

.timeline-item.negative {
    border-left-color: #ef4444;
}

.timeline-item.neutral {
    border-left-color: #6b7280;
}

.timeline-date {
    position: absolute;
    left: -2.5rem;
    top: 1.5rem;
    width: 1rem;
    height: 1rem;
    border-radius: 50%;
    background: #10b981;
    border: 2px solid white;
}

.timeline-item.negative .timeline-date {
    background: #ef4444;
}

.timeline-item.neutral .timeline-date {
    background: #6b7280;
}

.timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.timeline-title {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.25rem;
}

.timeline-type {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.type-trip { background: #dcfce7; color: #166534; }
.type-offset { background: #dbeafe; color: #1e40af; }
.type-alert { background: #fef3c7; color: #d97706; }
.type-milestone { background: #f3f4f6; color: #6b7280; }

.timeline-description {
    color: #6b7280;
    margin-bottom: 1rem;
    line-height: 1.5;
}

.timeline-impact {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1rem;
    border-top: 1px solid #e5e7eb;
}

.impact-amount {
    font-size: 1.25rem;
    font-weight: 700;
    color: #10b981;
}

.timeline-item.negative .impact-amount {
    color: #ef4444;
}

.timeline-item.neutral .impact-amount {
    color: #6b7280;
}

.impact-unit {
    font-size: 0.875rem;
    color: #6b7280;
    margin-left: 0.25rem;
}

.chart-container {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.chart-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
}

.chart-filters {
    display: flex;
    gap: 1rem;
}

.filter-button {
    padding: 0.5rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    background: white;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.3s ease;
}

.filter-button:hover {
    border-color: #10b981;
    color: #10b981;
}

.filter-button.active {
    background: #10b981;
    color: white;
    border-color: #10b981;
}

#impact-chart {
    height: 400px;
    position: relative;
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: #6b7280;
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-6 mb-8">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <span class="text-4xl">üåç</span>
            </div>
            <div class="ml-4">
                <h1 class="text-3xl font-bold text-gray-800">Environmental Impact History</h1>
                <p class="text-gray-600">Track your positive environmental contributions over time</p>
            </div>
        </div>
    </div>

    <!-- Impact Overview -->
    <div class="impact-overview">
        <div class="impact-card">
            <div class="impact-icon">üå±</div>
            <div class="impact-value">{{ total_carbon_saved|floatformat:1 }}</div>
            <div class="impact-label">Total CO‚ÇÇ Saved (kg)</div>
        </div>
        
        <div class="impact-card">
            <div class="impact-icon">üöó</div>
            <div class="impact-value">{{ total_sustainable_trips }}</div>
            <div class="impact-label">Sustainable Trips</div>
        </div>
        
        <div class="impact-card">
            <div class="impact-icon">üè≠</div>
            <div class="impact-value">{{ total_factory_hours_offset }}</div>
            <div class="impact-label">Factory Hours Offset</div>
        </div>
        
        <div class="impact-card neutral">
            <div class="impact-icon">üìä</div>
            <div class="impact-value">{{ impact_score|floatformat:0 }}</div>
            <div class="impact-label">Impact Score</div>
        </div>
    </div>

    <!-- Impact Chart -->
    <div class="chart-container">
        <div class="chart-header">
            <h2 class="chart-title">Impact Trends</h2>
            <div class="chart-filters">
                <button class="filter-button active" data-period="week">Week</button>
                <button class="filter-button" data-period="month">Month</button>
                <button class="filter-button" data-period="year">Year</button>
            </div>
        </div>
        <div id="impact-chart">
            <canvas id="impactChart"></canvas>
        </div>
    </div>

    <!-- Impact History Timeline -->
    <div class="impact-container">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Impact History</h2>
        
        {% if impact_history %}
            <div class="history-timeline">
                {% for impact in impact_history %}
                <div class="timeline-item {% if impact.impact_type == 'negative' %}negative{% elif impact.impact_type == 'neutral' %}neutral{% endif %}">
                    <div class="timeline-date"></div>
                    <div class="timeline-header">
                        <div>
                            <h3 class="timeline-title">{{ impact.title }}</h3>
                            <div class="timeline-type type-{{ impact.impact_type }}">
                                {{ impact.get_impact_type_display }}
                            </div>
                        </div>
                        <div class="timeline-date-text">{{ impact.created_at|date:"M d, Y" }}</div>
                    </div>
                    
                    <p class="timeline-description">{{ impact.description }}</p>
                    
                    <div class="timeline-impact">
                        <div>
                            <span class="impact-amount">
                                {% if impact.impact_type == 'negative' %}-{% endif %}{{ impact.impact_value|floatformat:1 }}
                            </span>
                            <span class="impact-unit">{{ impact.get_unit_display }}</span>
                        </div>
                        <div class="timeline-date-text">{{ impact.created_at|timesince }} ago</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">üåç</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">No Impact History Yet</h3>
                <p class="text-gray-600">Start logging sustainable trips to build your environmental impact history!</p>
                <a href="{% url 'employee_trip_log' %}" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    Log Your First Trip
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeChart();
    setupChartFilters();
});

let impactChart;

function initializeChart() {
    const ctx = document.getElementById('impactChart').getContext('2d');
    
    // Sample data - in real implementation, this would come from the backend
    const chartData = {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [
            {
                label: 'CO‚ÇÇ Saved (kg)',
                data: [2.5, 3.2, 2.8, 4.1, 3.5, 5.2, 4.8],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4
            },
            {
                label: 'Sustainable Trips',
                data: [2, 3, 2, 4, 3, 5, 4],
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4
            }
        ]
    };
    
    impactChart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

function setupChartFilters() {
    const filterButtons = document.querySelectorAll('.filter-button');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Update active state
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            const period = this.getAttribute('data-period');
            updateChartData(period);
        });
    });
}

function updateChartData(period) {
    // In a real implementation, this would fetch new data from the backend
    // For now, we'll just update with sample data
    let labels, carbonData, tripsData;
    
    switch(period) {
        case 'week':
            labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            carbonData = [2.5, 3.2, 2.8, 4.1, 3.5, 5.2, 4.8];
            tripsData = [2, 3, 2, 4, 3, 5, 4];
            break;
        case 'month':
            labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
            carbonData = [18.5, 22.3, 19.8, 24.1];
            tripsData = [15, 18, 16, 20];
            break;
        case 'year':
            labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
            carbonData = [85, 92, 78, 95, 88, 102];
            tripsData = [65, 70, 60, 72, 68, 75];
            break;
    }
    
    impactChart.data.labels = labels;
    impactChart.data.datasets[0].data = carbonData;
    impactChart.data.datasets[1].data = tripsData;
    impactChart.update();
}
</script>
{% endblock %}
