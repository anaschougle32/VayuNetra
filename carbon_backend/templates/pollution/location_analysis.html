{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
.pollution-indicator {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}

.aqi-good { background-color: #10b981; }
.aqi-moderate { background-color: #f59e0b; }
.aqi-unhealthy-sensitive { background-color: #f97316; }
.aqi-unhealthy { background-color: #ef4444; }
.aqi-very-unhealthy { background-color: #8b5cf6; }
.aqi-hazardous { background-color: #991b1b; }

.zone-marker {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}

.zone-heavy { background-color: #dc2626; }
.zone-manufacturing { background-color: #f59e0b; }
.zone-chemical { background-color: #8b5cf6; }
.zone-textile { background-color: #3b82f6; }
.zone-power { background-color: #10b981; }

.emotional-impact {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    font-size: 1.2em;
    margin: 20px 0;
}

.equivalent-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.equivalent-card .icon {
    font-size: 2.5em;
    margin-bottom: 10px;
}

.equivalent-card .value {
    font-size: 1.8em;
    font-weight: bold;
    color: #10b981;
}

.equivalent-card .label {
    color: #6b7280;
    font-size: 0.9em;
}

.risk-low { border-left: 4px solid #10b981; }
.risk-medium { border-left: 4px solid #f59e0b; }
.risk-high { border-left: 4px solid #ef4444; }
.risk-critical { border-left: 4px solid #991b1b; }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">{{ page_title }}</h1>
                <p class="text-gray-600">{{ location.address }}</p>
            </div>
            <a href="{% url 'pollution:dashboard' %}" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                ‚Üê Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Emotional Impact Message -->
    {% if emotional_message %}
        <div class="emotional-impact">
            <div class="text-3xl mb-3">üåç</div>
            <p class="font-semibold">{{ emotional_message }}</p>
        </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Industrial Zone Analysis -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Industrial Zone Analysis</h2>
            
            <div class="mb-4">
                <div class="flex justify-between items-center p-3 rounded {% if industrial_impact.risk_level == 'low' %}bg-green-50 risk-low{% elif industrial_impact.risk_level == 'medium' %}bg-yellow-50 risk-medium{% elif industrial_impact.risk_level == 'high' %}bg-red-50 risk-high{% else %}bg-red-100 risk-critical{% endif %}">
                    <div>
                        <h3 class="font-semibold">Risk Level: {{ industrial_impact.risk_level|upper }}</h3>
                        <p class="text-sm text-gray-600">{{ industrial_impact.active_zones }} active zones nearby</p>
                    </div>
                    <div class="text-2xl">
                        {% if industrial_impact.risk_level == 'low' %}‚úÖ{% elif industrial_impact.risk_level == 'medium' %}‚ö†Ô∏è{% elif industrial_impact.risk_level == 'high' %}üö®{% else %}üî¥{% endif %}
                    </div>
                </div>
            </div>

            {% if industrial_impact.zones %}
                <div class="space-y-3">
                    {% for zone in industrial_impact.zones %}
                        <div class="border rounded-lg p-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="zone-marker zone-{{ zone.type }}"></span>
                                    <div>
                                        <h4 class="font-medium">{{ zone.name }}</h4>
                                        <p class="text-sm text-gray-600">{{ zone.type }} ‚Ä¢ {{ zone.distance }} km away</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-semibold">{{ zone.emission_intensity }} tons CO‚ÇÇ/year</p>
                                    <p class="text-xs text-gray-500">Emission intensity</p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500">No active industrial zones nearby. Great location!</p>
            {% endif %}
        </div>

        <!-- Pollution Data -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Current Air Quality</h2>
            
            {% if pollution_data %}
                <div class="space-y-3">
                    {% for data in pollution_data|slice:":6" %}
                        <div class="flex justify-between items-center p-3 border rounded">
                            <div class="flex items-center">
                                <span class="pollution-indicator aqi-{{ data.aqi_level }}"></span>
                                <div>
                                    <h4 class="font-medium">{{ data.get_pollutant_type_display }}</h4>
                                    <p class="text-sm text-gray-600">{{ data.get_aqi_level_display }}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold">{{ data.value|floatformat:1 }} {{ data.unit }}</p>
                                <p class="text-xs text-gray-500">{{ data.timestamp|timesince }} ago</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500">No pollution data available for this location.</p>
                <button onclick="fetchPollutionData()" class="mt-3 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Fetch Real-time Data
                </button>
            {% endif %}
        </div>
    </div>

    <!-- Environmental Impact Equivalents -->
    {% if equivalents %}
        <div class="bg-white rounded-lg shadow-md p-6 mt-8">
            <h2 class="text-xl font-semibold mb-4">Your Environmental Impact Equivalents</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="equivalent-card">
                    <div class="icon">üè≠</div>
                    <div class="value">{{ equivalents.factory_hours|floatformat:1 }}</div>
                    <div class="label">Factory Hours Offset</div>
                </div>
                
                <div class="equivalent-card">
                    <div class="icon">üå≥</div>
                    <div class="value">{{ equivalents.trees_planted|floatformat:1 }}</div>
                    <div class="label">Trees Planted Equivalent</div>
                </div>
                
                <div class="equivalent-card">
                    <div class="icon">üöó</div>
                    <div class="value">{{ equivalents.cars_off_road|floatformat:1 }}</div>
                    <div class="label">Cars Off Road (1 day)</div>
                </div>
                
                <div class="equivalent-card">
                    <div class="icon">üèçÔ∏è</div>
                    <div class="value">{{ equivalents.motorbikes_off_road|floatformat:1 }}</div>
                    <div class="label">Motorbikes Off Road (1 day)</div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Carbon Savings Summary -->
    <div class="bg-white rounded-lg shadow-md p-6 mt-8">
        <h2 class="text-xl font-semibold mb-4">Carbon Savings Summary</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="text-center p-6 bg-green-50 rounded-lg">
                <div class="text-4xl mb-3">üå±</div>
                <h3 class="text-2xl font-bold text-green-800">{{ total_carbon_saved|floatformat:1 }} kg</h3>
                <p class="text-green-600">Total CO‚ÇÇ Saved at This Location</p>
            </div>
            
            <div class="text-center p-6 bg-blue-50 rounded-lg">
                <div class="text-4xl mb-3">üìç</div>
                <h3 class="text-lg font-semibold text-blue-800">{{ location.name|default:location.location_type|title }}</h3>
                <p class="text-blue-600">{{ location.address }}</p>
                <p class="text-sm text-gray-500 mt-2">
                    Lat: {{ location.latitude }}, Lng: {{ location.longitude }}
                </p>
            </div>
        </div>
    </div>
</div>

{{ location.latitude|json_script:"location_lat" }}
{{ location.longitude|json_script:"location_lng" }}
{{ location.address|json_script:"location_addr" }}

<script>
const locationData = {
    latitude: JSON.parse(document.getElementById('location_lat').textContent),
    longitude: JSON.parse(document.getElementById('location_lng').textContent),
    address: JSON.parse(document.getElementById('location_addr').textContent)
};

function fetchPollutionData() {
    fetch('/pollution/api/real-time-pollution/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            latitude: locationData.latitude,
            longitude: locationData.longitude
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Unable to fetch pollution data. Please try again later.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error fetching pollution data.');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Auto-check for pollution alerts
document.addEventListener('DOMContentLoaded', function() {
    fetch('/pollution/api/check-alerts/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            latitude: locationData.latitude,
            longitude: locationData.longitude,
            address: locationData.address
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.new_alerts > 0) {
            // Show notification for new alerts
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded shadow-lg z-50';
            notification.innerHTML = `
                <div class="flex">
                    <div class="flex-1">
                        <p class="font-semibold">New Pollution Alert!</p>
                        <p class="text-sm">${data.new_alerts} new pollution alert(s) detected.</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
    })
    .catch(error => console.error('Error checking alerts:', error));
});
</script>
{% endblock %}
